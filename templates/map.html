<!DOCTYPE html>
<html>
  <head>
    {% load static %}
    {% include "header.html" %}
    <script type="text/javascript" src="https://unpkg.com/default-passive-events"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link rel="stylesheet" type="text/css" href="{%static 'css/map.css' %}?v=1.02"/>
  </head>
  <body>
    {% include "cursorWave.html" %}
    <a href = "/map">
        <img title = "FriendHub Home" class = "home" style = "background: white;  border-radius: 50%; transition: 150ms ease-in-out; margin: 15px; position: absolute; height: 90px; width: 90px; z-index: 2;" src = "/static/images/logo.svg" /> </div>
    </a>    
    <div class="icons-container">
        <div class = "fPage">
            <a href="/friendList" class="home-label">
                <img title="view friends page" src="{% static 'images/friend.svg' %}" >
            </a>
            <p>friends</p>
        </div>
        <div class = "fPage">
            <a href="/logout" class="home-label">
                <img title="logout" src="{% static 'images/logout.svg' %}">
            </a>
            <p>logout</p>
        </div>
    </div>    
    <div id="map"></div>

    //map style selectors
    <select id="map-type-select"> 
        <option value="roadmap">Roadmap</option>
        <option value="satellite">Satellite</option>
        <option value="hybrid">Hybrid</option>
        <option value="terrain">Terrain</option>
    </select>

    <script src="{% url 'gMap' %}" defer></script>
    <script>
    function initMap() {
        const position = { lat: {{ latitude|safe }}, lng: {{ longitude|safe }} };
        // Initialize map centered at the given position
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 13,
            center: position,
            mapTypeControl: false,
            fullscreenControl: false,
            streetViewControl: false,
        });

        // Get the dropdown element
        const mapTypeSelect = document.getElementById("map-type-select");

        // Add an event listener to update the map type when the user makes a selection
        mapTypeSelect.addEventListener("change", function () {
            const selectedMapType = mapTypeSelect.value;
            map.setMapTypeId(selectedMapType);
        });

        function getRadiusFromPreference(preference) {
            switch (preference) {
                case 1: return 0;       // Exact location, so no circle
                case 2: return 500;    // 500m
                case 3: return 1000;   // 1000m
                case 4: return 2500;   // 2500m
                case 5: return 5000;   // 5000m
                default: return 100;   // Default to 100m
            }
        }

        // Handle friends' locations
        const friendsDetails = {{ friends_details|safe }};
            for (let friend of friendsDetails) {
            try {
                const friend_position = { lat: friend.latitude, lng: friend.longitude };
                // If the user wants their exact location shown
                if (friend.distancePreference === 1) {
                    new google.maps.Marker({
                        position: friend_position,
                        map: map,
                        title: `${friend.username} is here`
                    });
                } else {
                    // User does not want exact location shown so make a radius
                    const friend_radius = getRadiusFromPreference(friend.distancePreference);
                    const circle = new google.maps.Circle({
                        map: map,
                        center: friend_position,
                        radius: friend_radius,
                        fillColor: "#007bff",
                        fillOpacity: 0.2,
                        strokeColor: "#007bff",
                        strokeOpacity: 0.8,
                        clickable: true,
                        strokeWeight: 2,
                    });

                // Create an info window for this friend
                const infoWindow = new google.maps.InfoWindow();

                    // Add an event listener to the circle
                    google.maps.event.addListener(circle, 'click', function(event) {
                        // Calculate the center of the circle manually
                        const circleTop = {
                            lat: (friend_position.lat + (0.0009 * (friend_radius / 100))), // Adjusted latitude
                            lng: friend_position.lng
                        };
                        // Set the content for the info window
                        infoWindow.setContent(`In the circle: ${friend.username}`);
                        // Open the info window at the calculated center
                        infoWindow.setPosition(circleTop);
                        infoWindow.open(map);
                    });
                }
            } catch (e) {
                console.error("BRUUUHHHH");
            }
        }
    }
    window.initMap = initMap;
    </script>
    </body>
    <script src="../static/js/cursor.js"></script>
</html>