<!DOCTYPE html>
<html>
  <head>
    {% load static %}
    {% include "header.html" %}
    <script type="text/javascript" src="https://unpkg.com/default-passive-events"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link rel="stylesheet" type="text/css" href="{%static 'css/map.css' %}?v=1.01"/>
  </head>
  <body>
    <a href="/">
      <div class = "home-label">
          <img title = "return home" src="{% static 'images/home.svg' %}">
      </div>
    </a>
    <div id="map"></div>
    <script src="{% url 'gMap' %}" defer></script>
    <script>
    function initMap() {
        const position = { lat: {{ latitude|safe }}, lng: {{ longitude|safe }} };
        // Initialize map centered at the given position
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 13,
            center: position,
            mapTypeControl: true,
            fullscreenControl: false,
            streetViewControl: false,
            mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                position: google.maps.ControlPosition.TOP_RIGHT
            }
        });

        function getRadiusFromPreference(preference) {
            switch (preference) {
                case 1: return 0;       // Exact location, so no circle
                case 2: return 500;    // 500m
                case 3: return 1000;   // 1000m
                case 4: return 2500;   // 2500m
                case 5: return 5000;   // 5000m
                default: return 100;   // Default to 100m
            }
        }

        // Handle friends' locations
        const friendsDetails = {{ friends_details|safe }};
            for (let friend of friendsDetails) {
            try {
                const friend_position = { lat: friend.latitude, lng: friend.longitude };
                // If the user wants their exact location shown
                if (friend.distancePreference === 1) {
                    new google.maps.Marker({
                        position: friend_position,
                        map: map,
                        title: `${friend.username} is here`
                    });
                } else {
                    // User does not want exact location shown so make a radius
                    const friend_radius = getRadiusFromPreference(friend.distancePreference);
                    const circle = new google.maps.Circle({
                        map: map,
                        center: friend_position,
                        radius: friend_radius,
                        fillColor: "#007bff",
                        fillOpacity: 0.2,
                        strokeColor: "#007bff",
                        strokeOpacity: 0.8,
                        clickable: true,
                        strokeWeight: 2,
                    });

                // Create an info window for this friend
                const infoWindow = new google.maps.InfoWindow();

                    // Add an event listener to the circle
                    google.maps.event.addListener(circle, 'click', function(event) {
                        // Calculate the center of the circle manually
                        const circleTop = {
                            lat: (friend_position.lat + (0.0009 * (friend_radius / 100))), // Adjusted latitude
                            lng: friend_position.lng
                        };
                        // Set the content for the info window
                        infoWindow.setContent(`In the circle: ${friend.username}`);
                        // Open the info window at the calculated center
                        infoWindow.setPosition(circleTop);
                        infoWindow.open(map);
                    });
                }
            } catch (e) {
                console.error("BRUUUHHHH");
            }
        }
    }
    window.initMap = initMap;
    </script>
  </body>
</html>